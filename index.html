<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CSMA/CD æ¨¡æ‹Ÿ</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
        crossorigin="anonymous">
    <style>
        table#ether {
            margin-left: auto;
            margin-right: auto;
        }

        table#ether #cable td {
            border: 1px solid black;
            width: 40px;
            height: 40px;
            text-align: center;
        }

        table#ether #computers th[waiting='true']::before {
            content: "ğŸ˜´";
            padding: 5px;
            margin-right: 5px;
        }

        pre {
            border: 1px solid black;
            padding: 5px;
        }

        pre::before {
            content: "ğŸ“¨";
            font-size: 2em;
        }
    </style>
</head>

<body>
    
    <table id="ether">
        <tr id="computers">
        </tr>
        <tr id="cable">
        </tr>
    </table>
    <br>
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <form action="">
                            <div class="form-group">
                                <label for="">ä¸»æœºé€‰æ‹©</label>
                                <select class="form-control" id="computer">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                    <option>6</option>
                                    <option>7</option>
                                    <option>8</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="">ç›®æ ‡ä¸»æœº</label>
                                <select class="form-control" id="aimcomputer">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                    <option>6</option>
                                    <option>7</option>
                                    <option>8</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>æ¶ˆæ¯å†…å®¹</label>
                                <input class="form-control" type="text" id="sendcontent" placeholder="Hello world">
                            </div>
                            <button type="submit" class="btn btn-primary">æäº¤</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">

                    <div class="card-body">
                        <h4 class="card-title">æ”¶åˆ°çš„æ¶ˆæ¯</h4>
                        <ul id="messagelist" class="list-group">
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
<script src="https://cdn.bootcss.com/socket.io/2.1.0/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    const etherDOM = document.querySelector('#ether');
    const computersDOM = document.querySelector('#computers');
    const cableDOM = document.querySelector('#cable');
    const CABLE_LENGTH = 24; //ç”µæŠ¥-çº¿
    const COMPUTER_NUMBER = 8;
    const COLORS = ['#E00', '#0D0', '#00C', '#FC0', '#F0F', '#ACE', '#0AE', '#FA0'];
    const WAIT_INTERVAL_LOW = 10;
    const WAIT_INTERVAL_HIGH = 200;
    const RETRY_INTERVAL_LOW = 10;
    const RETRY_INTERVAL_HIGH = 50;
    var CLOCK = 500; // ç¡è§‰å•Š


    class Cell {
        //æ„é€ å‡½æ•°
        constructor(id, domobj) {
            this.id = id;
            this.obj = domobj;
            this.lifeTime = 0;
            this.propagating = false; //ç¹æ®–
        }
        //æ´»åŠ›æŸå¤± é¢œè‰²å˜æˆ0 å†…å®¹ä¸ºç©º
        energyLoss() {
            this.lifeTime = this.lifeTime > 0 ? this.lifeTime - 1 : 0;
            if (this.lifeTime == 0) {
                this.obj.innerText = '';
                this.obj.style.backgroundColor = '';
            }
        }
        //å‘é€çŠ¶æ€
        send(char) {
            if (this.obj.innerHTML == '') {
                this.obj.innerHTML = char;
                this.lifeTime = CABLE_LENGTH;
            } else if (this.obj.innerHTML != char) {
                this.obj.innerHTML = 'ERR!';
                this.lifeTime = CABLE_LENGTH;
            }
            this.obj.style.backgroundColor = char;
        }
    }
    // ç”µè„‘ç±»
    class Computer {
        constructor(id, color, cable) {
            this.id = id;
            this.color = color;
            this.cable = cable; //æ–¹å—
            this.obj = null;
            this.waiting = false;
            this.messages = [];
            this.sent = 0;
            // this.messagesObj = document.createElement('pre');
            // this.messagesObj.style.color = this.color;
            // document.body.appendChild(this.messagesObj);
        }
        // æ˜¾ç¤ºæ¶ˆæ¯
        showMessages() {
            // if(this.messages.length == 10) {
            //     this.messages = this.messages.slice(5, this.messages.length);
            // }
            this.messagesObj.innerHTML = this.messages;
        }
        //å‘é€æ¶ˆæ¯
        send(char) {
            if (this.etherEmpty()) {
                this.sent += 1;
                char = char || this.color;
                this.cable[this.id].propagating = true;
                this.cable[this.id].send(char);
            } else {
                this.obj.setAttribute('waiting', 'true');
                waitThenSend(RETRY_INTERVAL_LOW, RETRY_INTERVAL_HIGH, this);
            }
        }
        //æ¥å—æ¶ˆæ¯
        receive() {
            var mailbox = this.cable[this.id];
            //è¡¨æ ¼å¤„äºç¹æ®–çŠ¶æ€
            if (mailbox.propagating == true && mailbox.obj.innerText != this.color) {
                this.messages.push(mailbox.obj.innerText);
                this.showMessages();
            }
        }

        etherEmpty() {
            return this.cable[this.id].obj.innerText == '';
        }
    }
    //ç”Ÿæˆæ–¹å—
    function generateCable(len) {
        var result = [];
        var td = null;
        var cell = null;
        for (var i = 0; i < CABLE_LENGTH; i++) {
            td = document.createElement('td');
            td.innerHTML = '';
            cell = new Cell(i, td);
            result.push(cell);
        }
        return result;
    }
    //ç»˜åˆ¶ç”µæŠ¥çº¿
    function drawCable(arr, objcable, objcomputers) {
        var th = null;
        for (var elt of arr) {
            th = document.createElement('th');
            th.setAttribute('computer', elt.id + '');
            objcomputers.appendChild(th);
            objcable.appendChild(elt.obj);
        }
    }
    //ç”»ç”µè„‘
    function appendComputer(pc, obj) {
        for (var th of obj.children) {
            // debugger
            if (th.attributes.computer.value == pc.id) {
                pc.obj = th;
                pc.obj.innerHTML = 'ğŸ’»';
                pc.obj.style.color = pc.color;
            }
        }
    }
    // ç›‘å¬å¹¶ä¸”æ¶ˆæ¯é˜Ÿåˆ—
    function computersListen(arr) {
        for (var pc of arr) {
            pc.receive(); 
        }
    }
    // äº§ç”Ÿ-ç¹æ®–
    function propagate(cells) {
        var propagatingCells = [];

        for (var cell of cells) {
            //å¦‚æœåœ¨çŠ¶æ€å°±å‹å…¥å¤„äºäº§ç”Ÿæ€çš„æ ˆ
            if (cell.propagating == true) {
                propagatingCells.push(cell);
            }
            cell.energyLoss();
        }
        //å°†å‰ä¸€ä¸ªå’Œåä¸€ä¸ªè¿›è¡Œæ¸²æŸ“
        var next = null;
        var prev = null;

        for (var cell of propagatingCells) {
            next = cells[cell.id + 1];
            prev = cells[cell.id - 1];
            if (next !== undefined && next.obj.innerText != cell.obj.innerText) {
                next.send(cell.obj.innerText);
                next.propagating = true;
            }
            if (prev !== undefined && prev.obj.innerText != cell.obj.innerText) {
                prev.send(cell.obj.innerText);
                prev.propagating = true;
            }
            cell.propagating = false;
        }
    }
    //ç­‰å¾…ä¸€ä¸ªæ—¶é—´å†æ¬¡å‘é€æš‚æ—¶
    function waitThenSend(low, high, pc) {
        if (pc.waiting == false) {
            pc.waiting = true;
            //æš‚æ—¶è®©å®ƒç­‰å¾…å››ç§’
            var randomTimeout = 4000
            setTimeout(function () {
                pc.waiting = false;
                pc.obj.setAttribute('waiting', 'false');
                pc.send();
            }, randomTimeout);
        }
    }
    //ç›´æ¥å‘é€
    function NowSend(pc) {
        //å¦‚æœæ˜¯ä¸ç­‰å¾…çŠ¶æ€å³å‘é€çŠ¶æ€å°±è®©å…¶ç­‰å¾…çŠ¶æ€
        if (pc.waiting == false) {
            pc.waiting = true;
            var Timeout = 0 //4000æ—¶é—´
            setTimeout(function () {
                pc.waiting = false;
                pc.obj.setAttribute('waiting', 'false');
                pc.send();
            }, Timeout); //åªæ‰§è¡Œä¸€æ¬¡
        }
    }
    // ç”µè„‘éšæœºå‘é€ TODO ä¿®æ”¹æœ¬å‡½æ•°
    function randomComputerSends(arr, chance) {
        var willSend = Math.random() < chance;
        if (willSend) {
            var randComputer = Math.floor(Math.random() * arr.length);
            waitThenSend(WAIT_INTERVAL_LOW, WAIT_INTERVAL_HIGH, arr[randComputer]);
        }
    }
    //ç”»è¡¨æ ¼
    const cable = generateCable(CABLE_LENGTH);
    drawCable(cable, cableDOM, computersDOM);

    console.log(cable)
    //ç”»ç”µè„‘ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ä¸ªæ•°ï¼‰
    const computers = [];
    for (var i = 0; i < COMPUTER_NUMBER; i++) {
        computers.push(new Computer(i * Math.floor(CABLE_LENGTH / COMPUTER_NUMBER), COLORS[i], cable));
        appendComputer(computers[i], computersDOM);
    }
    //ä¸»è¿›ç¨‹ï¼Œä¸åœå¾ªç¯
    setInterval(function () {
        //computersListen(computers); //ç»˜åˆ¶åœ°ä¸‹çš„æ¶ˆæ¯æ¡†
        // randomComputerSends(computers, 0.1); //ç”±socketæ¨¡å—æ¥ç®¡
        propagate(cable);
    }, CLOCK);

    $(function () {
        var socket = io();
        $('form').submit(function () {
            sendrequest = $("#computer option:selected").val() + ":" + $("#aimcomputer option:selected").val() + ":" + $('#sendcontent').val();
            socket.emit('send request', sendrequest);
            $('#m').val('');
            return false;
        });
        socket.on('feedback', function (msg) {
            // $('#messages').append($('<li>').text(msg));
            // window.scrollTo(0, document.body.scrollHeight);
            // å½“å‰è®¡ç®—æœº
            computer = $("#computer option:selected").val()
            newmsg = msg.split(":");
            sendcomputer = newmsg[0]; //å‘é€çš„ä¸»æœº
            aimcomputer = newmsg[1]; // æ¥å—çš„ä¸»æœº
            content = newmsg[2]; //æ¶ˆæ¯å†…å®¹
            message = sendcomputer + 'å¼€å§‹å‘é€'
            NowSend(computers[parseInt(sendcomputer) - 1]); //ä¸»æœºå·ç æ˜¯è®¡ç®—æœºå·åŠ ä¸€
            $("#messagelist").append('<li class="list-group-item">' + message + '</li>')
            if($("#computer option:selected").val() == aimcomputer){
                $("#messagelist").append('<li class="list-group-item list-group-item-success">' + "æ”¶åˆ°ä»"+sendcomputer+"å‘æ¥çš„æ¶ˆæ¯ï¼Œå†…å®¹ä¸º"+content + '</li>')
            }
        });
    });


</script>

</html>